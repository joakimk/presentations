<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Toniq</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"/>

  <link rel="stylesheet" href=".//css/reset.css" type="text/css"/>

  

  <link rel="stylesheet" type="text/css" href=".//css/fg.menu.css" media="screen" />
  <link rel="stylesheet" type="text/css" href=".//css/theme/ui.all.css" media="screen" />
  <link rel="stylesheet" type="text/css" href=".//css/highlight/default.css"  />

  <link rel="stylesheet" type="text/css" href=".//css/showoff.css" />

  <!--[if lte IE 8]>
    <link rel="stylesheet" type="text/css" href=".//css/ie8.css" />
  <![endif]-->

  <script type="text/javascript" src=".//js/jquery-2.1.4.min.js"></script>

  <script type="text/javascript" src=".//js/jquery.cycle.all.js"></script>
  <script type="text/javascript" src=".//js/jquery-print.js"></script>
  <script type="text/javascript" src=".//js/jquery.batchImageLoad.js"></script>
  <script type="text/javascript" src=".//js/jquery.parsequery.min.js"></script>
  <script type="text/javascript" src=".//js/jquery.doubletap-0.1.js"></script>
  <script type="text/javascript" src=".//js/fg.menu.js"></script>
  <script type="text/javascript" src=".//js/jTypeWriter.js"> </script>
  <script type="text/javascript" src=".//js/highlight.pack.js"></script>

  <script type="text/javascript" src=".//js/coffee-script.js"></script>

  <script type="text/javascript" src=".//js/showoff.js"></script>

  

  

  <script type="text/javascript">
    $(function(){
      setupPreso(false, './');
    });

    editUrl  = "";

    keymap = {
  "space": "NEXT",
  "d": "DEBUG",
  "up": "PREV",
  "left": "PREV",
  "pageup": "PREV",
  "down": "NEXT",
  "right": "NEXT",
  "pagedown": "NEXT",
  "r": "RELOAD",
  "c": "CONTENTS",
  "t": "CONTENTS",
  "h": "HELP",
  "/": "HELP",
  "?": "HELP",
  "b": "BLANK",
  ".": "BLANK",
  "F": "FOOTER",
  "f": "FOLLOW",
  "n": "NOTES",
  "esc": "CLEAR",
  "p": "PAUSE",
  "P": "PRESHOW",
  "x": "EXECUTE",
  "f5": "EXECUTE"
};
  </script>

</head>

<body>

<a tabindex="0" href="#search-engines" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="navmenu"><span class="ui-icon ui-icon-triangle-1-s"></span>slides</a>
<div id="navigation" class="hidden"></div>


<div id="help">
  <h1>Showoff Hotkeys</h1>
  <div>
    <span class="description">Move to the next slide.</span>
    <span class="action">NEXT</span>
    <span class="hotkeys"><span class="key">space</span><span class="key">down</span><span class="key">right</span><span class="key">pagedown</span></span>
  </div>
  <div>
    <span class="description">Move to the previous slide.</span>
    <span class="action">PREV</span>
    <span class="hotkeys"><span class="key">up</span><span class="key">left</span><span class="key">pageup</span></span>
  </div>
  <div>
    <span class="description">Show the table of contents menu.</span>
    <span class="action">CONTENTS</span>
    <span class="hotkeys"><span class="key">c</span><span class="key">t</span></span>
  </div>
  <div>
    <span class="description">Toggle follow mode.</span>
    <span class="action">FOLLOW</span>
    <span class="hotkeys"><span class="key">f</span></span>
  </div>
  <div>
    <span class="description">Show this help dialog.</span>
    <span class="action">HELP</span>
    <span class="hotkeys"><span class="key">h</span><span class="key">/</span><span class="key">?</span></span>
  </div>

  <hr />

  <div>
    <span class="description">Reload all slides.</span>
    <span class="action">RELOAD</span>
    <span class="hotkeys"><span class="key">r</span></span>
  </div>
  <div>
    <span class="description">Blank the screen.</span>
    <span class="action">BLANK</span>
    <span class="hotkeys"><span class="key">b</span><span class="key">.</span></span>
  </div>
  <div>
    <span class="description">Toggle the display footer.</span>
    <span class="action">FOOTER</span>
    <span class="hotkeys"><span class="key">F</span></span>
  </div>
  <div>
    <span class="description">Toggle notes display.</span>
    <span class="action">NOTES</span>
    <span class="hotkeys"><span class="key">n</span></span>
  </div>
  <div>
    <span class="description">Clear code execution results.</span>
    <span class="action">CLEAR</span>
    <span class="hotkeys"><span class="key">esc</span></span>
  </div>
  <div>
    <span class="description">Pause the presentation.</span>
    <span class="action">PAUSE</span>
    <span class="hotkeys"><span class="key">p</span></span>
  </div>
  <div>
    <span class="description">Display slideshow of <tt>preshow</tt> images on a timer.</span>
    <span class="action">PRESHOW</span>
    <span class="hotkeys"><span class="key">P</span></span>
  </div>
  <div>
    <span class="description">Execute the first visible code block.</span>
    <span class="action">EXECUTE</span>
    <span class="hotkeys"><span class="key">x</span><span class="key">f5</span></span>
  </div>

  <hr />

  <div>
    <span class="description">Show debugging information.</span>
    <span class="action">DEBUG</span>
    <span class="hotkeys"><span class="key">d</span></span>
  </div>
</div>

<div class="buttonNav">
  <input type="submit" onClick="prevStep();" value="prev"/>
  <input type="submit" onClick="nextStep();" value="next"/>
</div>

<div id="preso"><center>loading presentation...</center></div>
<div id="footer">
  <span id="followMode"></span>
  <span id="slideInfo"></span>
  <span id="debugInfo"></span>
  <span id="notesInfo"></span>
  <span id="slideFilename"></span>
  <img id="disconnected" src=".//css/disconnected.png" />
</div>

<div id="slides" class="offscreen" style="display:none;">
<div id="slides_slide01" class="slide center First bullets" data-transition="none">
<div class="content center First bullets" ref="slides/slide01/1">
<h1>Toniq</h1>

<p>A simple and reliable background job library for Elixir</p>
</div>
</div>
<div id="slides_slide01" class="slide bullets" data-transition="none">
<div class="content bullets" ref="slides/slide01/2">
<h2>Who am I?</h2>

<p>My name is Joakim Kolsj√∂</p>

<p>Ruby developer since 2008</p>

<p>Exploring elixir :)</p>
</div>
</div>
<div id="slides_slide01" class="slide bullets" data-transition="none">
<div class="content bullets" ref="slides/slide01/3">
<p>Before we get into toniq, let's go through a bit of background</p>
</div>
</div>
<div id="slides_slide01" class="slide bullets" data-transition="none">
<div class="content bullets" ref="slides/slide01/4">
<h2>Do it yourself?</h2>

<p>Background process, easy right?</p>

<pre class="highlight"><code class="language-elixir">spawn fn -&gt;
  do_work
end</code></pre>

<p>Yes, but...</p>

<p>What happens when it crashes?</p>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/5">
<h2>So what to do?</h2>

<pre class="highlight"><code class="language-elixir">spawn_link fn -&gt;
  do_work
end</code></pre>

<p>Now we're getting better, this will crash the calling process too!</p>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/6">
<h2>Using a OTP supervisor?</h2>

<p>This could work really well. Workers are restarted when they fail.</p>

<p>But messages, e.g. jobs are lost when it crashes.</p>

<p>A building block, but not a complete solution.</p>
</div>
</div>
<div id="slides_slide01" class="slide bullets" data-transition="none">
<div class="content bullets" ref="slides/slide01/7">
<h2>So I went looking for something that was:</h2>

<p>simple to use</p>

<p>familiar to ruby developers</p>

<p>reliable and explicit about error handing</p>

<p>work well in limited environments like heroku<br>
(redis instead of mnesia or dets)</p>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/8">
<h2>Didn't find anything suitable</h2>

<p>Nothing lived up to my expectations.</p>

<p>Could be what to expect in elixir compared to ruby,<br>
but it's also oppurtunity to do green field development.</p>

<p><strong>github.com/akira/exq</strong> is interesting if you want resque/sidekiq compatibility.</p>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/9">
<h2>Introducing toniq</h2>

<pre class="highlight"><code class="language-elixir">defmodule LazyWorker do
  use Toniq.Worker

  def perform(sleep: 0), do: # nothing
  def perform(sleep: duration) do
    :timer.sleep duration
  end
end

Toniq.enqueue(LazyWorker, sleep: 1000)</code></pre>

<p>No spinning up workers, persisted and run right away.</p>

<p>Pattern matching + erlang serialization.</p>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/10">
<h2>Pipelines!</h2>

<p>Using Toniq.enqueue_to...</p>

<pre class="highlight"><code class="language-elixir">def create(conn, params) do
  params
  |&gt; extract_sleep_duration
  |&gt; Toniq.enqueue_to(LazyWorker)

  conn |&gt; text("ok")
end</code></pre>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/11">
<h2>Concurrency</h2>

<p>Basically unlimited by default.</p>

<p>One job = one erlang process.</p>

<p>One VM = 100k+ erlang processes.</p>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/12">
<h2>The journey of building toniq</h2>

<p>Very fun experience.</p>

<p>Learned much about OTP from "Elixir in Action"</p>

<p>Already pretty used to functional programming though<br>
intentionally working that way in ruby (recommended!).</p>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/13">
<h2>A bit different: redis as backup and failover</h2>

<p>Toniq runs jobs within the VM that enqueued them.</p>

<p>Redis is used as a backup, not as a message queue.</p>

<p>Takeover of orphaned jobs is done using a redis transaction.<br></p>

<p><strong>Simple design to avoid complexity</strong></p>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/14">
<h2>Good error messages</h2>

<p>Making confusing error messages is easy,<br>
making good ones is not that much more work.</p>

<p><img src="./file/slides/good_error_messages.png" alt="good error messages"></p>

<pre><code>[error] Job #19:
Toniq.TestWorker.perform(:fail_once)
failed with error:
%RuntimeError{message: "failing once"}
</code></pre>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/15">
<h2>Handling failed jobs</h2>

<p>Easy CLI interface to handle failed jobs (which are reported to <strong>honeybadger</strong> or similar tools though error logging).</p>

<pre class="highlight"><code class="language-elixir">heroku run iex -S mix

iex&gt; job = Toniq.failed_jobs |&gt; hd
%{id: 3, opts: [], worker: LazyWorker}

iex&gt; # Toniq.retry(job)
iex&gt; Toniq.delete(job)

iex&gt; Toniq.failed_jobs |&gt;
     Enum.each &amp;Toniq.retry/1</code></pre>

<p>Admin web UI is planned, contributions welcome.</p>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/16">
<h2>Benchmarks (quick jobs)</h2>

<p><br></p>

<p><strong>Sidekiq</strong> (ruby 2.2.3, 4 processes, 1000 threads):<br></p>

<p>10 000 quick jobs, in 4.68 seconds, 2136 jobs / second<br></p>

<p><br>
<br>
<strong>Toniq</strong> (elixir 1.1.1 / erlang 1.8, 1 process):</p>

<p>10 000 quick jobs, in 1.8 seconds, <strong>5500 jobs / second</strong> (2.5x)<br>
<br> <br> <br> <br> <br></p>

<p>(iMac, mid 2011, quad-core i7, 3.4ghz)</p>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/17">
<h2>Benchmarks (slow jobs: 5 second sleep)</h2>

<p><br></p>

<p><strong>Sidekiq</strong> (ruby 2.2.3, 4 processes, 1000 threads):<br></p>

<p>10 000 slow jobs, in 51 seconds,   196 jobs/second</p>

<p><br>
<br>
<strong>Toniq</strong> (elixir 1.1.1 / erlang 1.8, 1 process):</p>

<p>10 000 slow jobs, in 6.8 seconds, <strong>1470 jobs/second</strong> (7.5x)
<br> <br> <br> <br> <br></p>

<p>(iMac, mid 2011, quad-core i7, 3.4ghz)</p>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/18">
<h2>Status of toniq?</h2>

<p>Error handling works</p>

<p>Concurrency works</p>

<p>Failover works</p>

<p>In production use in a small internal project.</p>

<p>Not yet 1.0 but close.</p>
</div>
</div>
<div id="slides_slide01" class="slide " data-transition="none">
<div class="content " ref="slides/slide01/19">
<h2>¬†</h2>

<p><strong>@joakimk</strong> | <strong>github.com/joakimk/toniq</strong></p>

<p>contributions? admin ui, benchmarks, ...</p>

<p>pair on using toniq in your app?</p>

<p><strong>dev.auctionet.com</strong> - we're hiring (ruby devs)</p>

<p>any questions?</p>

<p>thank you!</p>
</div>
</div>
</div>
<div id="pauseScreen">
  PAUSED
</div>

</body>
</html>
